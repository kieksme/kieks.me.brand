name: Create Release Assets

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get release version
        id: version
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          VERSION=${TAG_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create assets directory structure
        run: |
          mkdir -p release-assets

      - name: Copy release assets
        run: |
          # Copy all assets directory (includes logos, colors, fonts, templates, guidelines)
          cp -r assets release-assets/
          
          # Copy root level documentation files
          cp README.md release-assets/
          cp LICENSE release-assets/

      - name: Create ZIP archive
        run: |
          cd release-assets
          zip -r ../kieks-me-assets-v${{ steps.version.outputs.version }}.zip .
          cd ..

      - name: Generate Release README
        id: readme
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_DATE=$(date -u +"%Y-%m-%d")
          
          # Extract changelog section for current version
          CHANGELOG_SECTION=""
          if [ -f CHANGELOG.md ]; then
            # Extract the changelog entry for this version (from ## [VERSION] to next ## or end of file)
            CHANGELOG_ENTRY=$(awk "/^## \[${VERSION}\]/,/^## \[/{if (/^## \[/ && !/^## \[${VERSION}\]/) exit; print}" CHANGELOG.md | tail -n +2)
            if [ -n "$CHANGELOG_ENTRY" ] && [ "$CHANGELOG_ENTRY" != "" ]; then
              # Convert changelog format to release notes format and save to temp file
              echo "$CHANGELOG_ENTRY" | \
                sed 's/^### Features/## âœ¨ What'\''s New in v'"${VERSION}"'\n\n### Features/' | \
                sed 's/^\* \*\*\([^:]*\):\*\*/- **\1**:/' | \
                sed 's/^\* /  - /' | \
                sed 's/^### Bug Fixes/\n### Bug Fixes/' > /tmp/changelog_section.txt
            fi
          fi
          
          # Replace placeholders in template
          sed -e "s/\${VERSION}/${VERSION}/g" \
              -e "s/\${RELEASE_DATE}/${RELEASE_DATE}/g" \
              RELEASE_README.md > /tmp/release_readme_temp.md
          
          # Replace CHANGELOG_SECTION placeholder
          if [ -f /tmp/changelog_section.txt ]; then
            awk '/\$\{CHANGELOG_SECTION\}/ {while ((getline line < "/tmp/changelog_section.txt") > 0) print line; close("/tmp/changelog_section.txt"); next} {print}' /tmp/release_readme_temp.md > RELEASE_README.md
          else
            sed 's|\${CHANGELOG_SECTION}||g' /tmp/release_readme_temp.md > RELEASE_README.md
          fi
          
          echo "readme_path=RELEASE_README.md" >> $GITHUB_OUTPUT

      - name: Upload ZIP to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./kieks-me-assets-v${{ steps.version.outputs.version }}.zip
          asset_name: kieks-me-assets-v${{ steps.version.outputs.version }}.zip
          asset_content_type: application/zip

      - name: Update Release Notes
        run: |
          gh release edit ${{ github.event.release.tag_name }} \
            --repo ${{ github.repository }} \
            --notes-file RELEASE_README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
